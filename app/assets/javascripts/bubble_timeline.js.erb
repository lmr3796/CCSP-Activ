var start = -1,end = -1,light=new Array(),ctime = 0,block = 0,temp;
var new_move_bubble = '<p id="new_move" class="triangle-border left" style="text-align:center;position:absolute;top:'+t_o(ctime)+'px; "><textarea cols="30" rows="4" id="new_move_content"></textarea><br/><button id="confirm">Confirm</button><button id="cancel">Cancel</button></p>'
function set_light_and_bubble(){
    var counter = 0;
    //Remove old bubbles
    $(".triangle-border").remove();

    //Render new bubbles
    $.each(light,function(k,v){
        time = v[0];
        content = v[1];
        if((counter)%2 ==0){
            $("#light").append('<p class="triangle-border right" style="position:absolute;top:'+t_o(time)+'px;right:52.5%;">'+content+'</p>');
        }else{
            $("#spotlight").append('<p class="triangle-border left" style="position:absolute;top:'+t_o(time)+'px; ">'+content+'</p>');
        }
        counter++;
    });
}

function load_data(){
    /*
       var light = {   0: "橘紅色燈約50% 噴點乾冰",
       13: "亮度約80% 顏色可隨著節拍換",
       24: "隨便打",
       103: "燈暗",
       267: "燈慢慢變亮(到半亮)",
       275: "燈半亮、spot light 打往前走的人",
       288: "一閃一閃的感覺但不要魔鬼燈",
       292: "燈全亮",
       342: "燈微亮，spot light亂打",
       347: "不同顏色的燈輪流打",
       362: "燈全亮",
       508: "End"
       };*/
    light = my_light;
    set_light_and_bubble();
}

$(document).ready(function(){
    load_data();
    $("#circle").click(function(event){
        $("#jquery_jplayer_1").jPlayer("pause");
        $("#spotlight").append(new_move_bubble);
        $("#new_move_content").focus();
        $("#confirm").click(function(){
            var form = $("#new_light_script");
            var move = $("#new_move_content").val();
            $("#create_move_fail").remove();
            add_light_move(ctime, move);
        });
        $("#cancel").click(function(){
            $("#new_move").remove();
        });
        $("#new_move").click(function(e){
            e.stopPropagation();
        });
        event.stopPropagation()
        $(document).click(function(){
            $("#new_move").remove();
        });
    });

    $("#circle").hover(function(){
        temp = $("#circle").html();
        $("#circle").html("+");
        block = 1;
    },function(){
        $("#circle").html(temp);
        block = 0;
    });

    $("#outer").height(document.documentElement.clientHeight-23);
    $("#timeline").css("top",23-document.documentElement.clientHeight);

    $("#circle").css("top",(document.documentElement.clientHeight-23)/2-16);
    $("#line").height(document.documentElement.clientHeight-23);


    $("#hip").click(function(){
        set(0,105,"Hiphop");
    });
    $("#lockin").click(function(){
        set(106,207,"Lockin");
    });
    $("#pop").click(function(){
        set(208,266,"Poppin");
    });
    $("#gs").click(function(){
        set(266,345,"Girl Style");
    });
    $("#yn").click(function(){
        set(344,434,"House");
    });
    $("#battle").click(function(){
        set(436,508,"Battle");
    });
    $("#whole").click(function(){
        set(-1,-1,"Old Dance");
    });


    $("#jquery_jplayer_1").jPlayer({
        ready: function (event) {
            $(this).jPlayer("setMedia", {
                m4a: my_m4a,
                oga: my_oga,
                mp3: my_mp3,
            });
        },
        timeupdate:function(event){
            ctime = event.jPlayer.status.currentTime;
            if(start != -1 && end != -1){
                current = Math.floor(event.jPlayer.status.currentTime);
                if(current > end + 1 || current < start - 1){
                    start = -1;
                    end = -1;
                }
                else{
                    if(current == end || current == end + 1){
                        $("#jquery_jplayer_1").jPlayer("play", start);
                    }
                }
            }

            var change = 0;
            $.each(light,function(k,v){
                var t = v[0] - event.jPlayer.status.currentTime;

                if( t > 0 && change == 0 && block == 0){
                    $("#circle").html(Math.floor(t));
                    change = 1;
                    return;
                }
            });
            if(change == 0 && block == 0)
                $("#circle").html("");

            var time = (Math.floor(event.jPlayer.status.currentTime*10)/10)*10;
            $("#timeline").offset({top : -time + (document.documentElement.clientHeight-23)/2});
        },
        solution: 'html, flash',
        swfPath: "js",
        supplied: "mp3,oga,m4a",
        preload: 'metadata',
        volume: 1.0,
        muted: false,
    });
});
function light_move_valid(time, move){
    if(move == ""){
        $("#new_move").append('<span id="create_move_fail" style="color:red">請輸入燈音內容</span>');
        return false;
    }
    if(move.length > 200){
        $("#new_move").append('<span id="create_move_fail" style="color:red">燈音內容過長</span>');
        return false;
    }
    return true;
}
function add_light_move(time, move){
    if(!light_move_valid(time, move)){return;}
    var data_str = "";
    var form = $("#new_light_script");
    form.find("#light_script_time").val(time);
    form.find("#light_script_move").val(move);
    form.find("input").each(function(index, element){
        data_str += element.name+'='+element.value + '&';
    });
    data_str = data_str.substring(0, data_str.length - 1);
    $.ajax({
        type: "POST",
        url: "light/createjizz",
        data: data_str,
        success: function() {
            set_light_and_bubble();
            light.push(new Array(time, move));
        },
        error: function() {
            $("#new_move").append('<span id="create_move_fail" style="color:red">上傳失敗</span>');
        },
    });
}
function t_o(t){
    return t*10-38 ;
}
function set(s,e,t){
    start = s;
    end = e;
    if(s != -1)
        $("#jquery_jplayer_1").jPlayer("play", start);
    $("#title").html(t);
}
