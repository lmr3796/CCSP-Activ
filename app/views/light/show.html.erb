<!DOCTYPE html>
<html>
    <head>
        <!-- Website Design By: www.happyworm.com -->
        <title>老人舞燈音表</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="robots" content="noindex, NOFOLLOW" />
        <%= stylesheet_link_tag "application" %>
        <%= stylesheet_link_tag "light" %>
    </head>
    <body >
        <table width="100%" height="100%">
            <tr>
                <td width="60%" height="100%" >
                    <div id="outer" style="width:99%;height:100%;min-height:100%;overflow:hidden;">
                        <div id="circle" style="background-image:url(<%= asset_path "square.png" %>);width:40px;height:40px;position:relative;left:48.5%;z-index:100;font-size:30px;color:white;text-align:center">5</div>
                        <div id="line" style="height:300px;background-color: #BBBAF4; width:3px;position:relative;left:50%;z-index:50"></div>
                        <div id="timeline" style="width:100%;height:2550px;position:relative;top:-499px;">
                            <table width="100%" height="100%">
                                <tr>
                                    <td width="50%">
                                        <div id="light" style="height:100%;margin:5%">
                                        </div>
                                    </td>
                                    <td width="50%">
                                        <div id="spotlight" style="height:100%;margin:5%">
                                        </div>
                                    </td>
                                </tr>
                            </table>

                        </div>
                    </div>
                </td>
                <td height="100%">
                    <div id="jquery_jplayer_1" class="jp-jplayer" ></div>

                    <div id="jp_container_1" class="jp-audio" style="position:absolute;right:0%;top:0%;z-index:75">
                        <div class="jp-type-single" >
                            <div class="jp-gui jp-interface">
                                <ul class="jp-controls">
                                    <li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
                                    <li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
                                    <li><a href="javascript:;" class="jp-stop" tabindex="1">stop</a></li>
                                    <li><a href="javascript:;" class="jp-mute" tabindex="1" title="mute">mute</a></li>
                                    <li><a href="javascript:;" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
                                    <li><a href="javascript:;" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
                                </ul>
                                <div class="jp-progress">
                                    <div class="jp-seek-bar">
                                        <div class="jp-play-bar"></div>

                                    </div>
                                </div>
                                <div class="jp-volume-bar">
                                    <div class="jp-volume-bar-value"></div>
                                </div>
                                <div class="jp-current-time"></div>
                                <div class="jp-duration"></div>
                                <ul class="jp-toggles">
                                    <li><a href="javascript:;" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
                                    <li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
                                </ul>
                            </div>
                            <div class="jp-title">
                                <ul>
                                    <li><h2 id="title">Old Dance</h2></li>
                                </ul>
                                <div>
                                    <ul>
                                        <li><a href="#" id="hip">Hip hop repeat</a></li>
                                        <li><a href="#" id="lockin">Lockin repeat</a></li>
                                        <li><a href="#" id="pop"> Popping repeat</a></li>
                                        <li><a href="#" id="gs">Girl Style repeat</a></li>
                                        <li><a href="#" id="yn">Yes or No repeat</a></li>
                                        <li><a href="#" id="battle">Battle repeat</a></li>
                                        <li><a href="#" id="whole">Whole</a></li>
                                    </ul>

                                </div>
                            </div>
                            <div class="jp-no-solution">
                                <span>Update Required</span>
                                To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        <div id="line2" style="background-color: #333;width:100%;height:0%;position:absolute;right:0%;top:0px;z-index:80;color:white"></div>
        <%= javascript_include_tag "application" %>
        <script type="text/javascript">
            //<![CDATA[
        var start = -1,end = -1,light=new Array(),ctime = 0,block = 0,temp;

        function load_data(){
            $.get('/old.json', function(data) {
                    if(data != null){
                    light = data;
                    var counter = 0;
                    $.each(light,function(k,v){
                        time = v[0];
                        content = v[1];
                        if((counter)%2 ==0)
                        $("#light").append('<p class="triangle-border right" style="position:absolute;top:'+t_o(time)+'px;right:510px">'+content+'</p>');
                        else
                        $("#spotlight").append('<p class="triangle-border left" style="position:absolute;top:'+t_o(time)+'px; ">'+content+'</p>');
                        counter++;
                        });
                    }
                    },"json");
        }

$(document).ready(function(){
        /*
           var light = {   0: "橘紅色燈約50% 噴點乾冰",
13: "亮度約80% 顏色可隨著節拍換",
24: "隨便打",
103: "燈暗",
267: "燈慢慢變亮(到半亮)",
275: "燈半亮、spot light 打往前走的人",
288: "一閃一閃的感覺但不要魔鬼燈",
292: "燈全亮",
342: "燈微亮，spot light亂打",
347: "不同顏色的燈輪流打",
362: "燈全亮",
508: "End"
};*/
        //load_data();
        light = <%=raw @script %>
        var counter = 0;
        $.each(light,function(k,v){
            time = v[0];
            content = v[1];
            if((counter)%2 ==0)
            $("#light").append('<p class="triangle-border right" style="position:absolute;top:'+t_o(time)+'px;right:52.5%;">'+content+'</p>');
            else
            $("#spotlight").append('<p class="triangle-border left" style="position:absolute;top:'+t_o(time)+'px; ">'+content+'</p>');
            counter++;
            });

$("#circle").click(function(){
        $("#jquery_jplayer_1").jPlayer("pause");
        $("#spotlight").append('<p id="new" class="triangle-border left" style="text-align:center;position:absolute;top:'+t_o(ctime)+'px; "><textarea cols="40" rows="4" id="new_event"></textarea><br/><button id="confirm">Confirm</button><button id="cancel">Cancel</button></p>');

        $("#confirm").click(function(){
            light.push(new Array(ctime,$("#content").val()));
            $.get("save.php",{"data":light},function(result){
                if(result){
                $("#new").remove();
                load_data();
                }
                },"json");
            });
        $("#cancel").click(function(){
            $("#new").remove();
            });
        });

$("#circle").hover(function(){
        temp = $("#circle").html();
        $("#circle").html("+");
        block = 1;
        },function(){
        $("#circle").html(temp);
        block = 0;
        });

$("#outer").height(document.documentElement.clientHeight-23);
$("#timeline").css("top",23-document.documentElement.clientHeight);

$("#circle").css("top",(document.documentElement.clientHeight-23)/2-16);
$("#line").height(document.documentElement.clientHeight-23);


$("#hip").click(function(){
        set(0,105,"Hiphop");
        });
$("#lockin").click(function(){
        set(106,207,"Lockin");
        });
$("#pop").click(function(){
        set(208,266,"Poppin");
        });
$("#gs").click(function(){
        set(266,345,"Girl Style");
        });
$("#yn").click(function(){
        set(344,434,"House");
        });
$("#battle").click(function(){
        set(436,508,"Battle");
        });
$("#whole").click(function(){
        set(-1,-1,"Old Dance");
        });


$("#jquery_jplayer_1").jPlayer({
ready: function (event) {
$(this).jPlayer("setMedia", {
m4a: "<%= @m4a %>",
oga: "<%= @oga %>",
mp3: "<%= @mp3 %>",
});
},
timeupdate:function(event){
ctime = event.jPlayer.status.currentTime;
if(start != -1 && end != -1){
current = Math.floor(event.jPlayer.status.currentTime);
if(current > end + 1 || current < start - 1){
start = -1;
end = -1;
}
else{
if(current == end || current == end + 1){
$("#jquery_jplayer_1").jPlayer("play", start);
}
}
}

var change = 0;
$.each(light,function(k,v){
        var t = v[0] - event.jPlayer.status.currentTime;

        if( t > 0 && change == 0 && block == 0){
        $("#circle").html(Math.floor(t));
        change = 1;
        return;
        }
        });
if(change == 0 && block == 0)
    $("#circle").html("");

    var time = (Math.floor(event.jPlayer.status.currentTime*10)/10)*10;
    $("#timeline").offset({top : -time + (document.documentElement.clientHeight-23)/2});
    },
solution: 'html, flash',
    swfPath: "js",
    supplied: "mp3,oga,m4a",
    preload: 'metadata',
    volume: 1.0,
    muted: false,

    });
});
function t_o(t){
    return t*10-38 ;
}
function set(s,e,t){
    start = s;
    end = e;
    if(s != -1)
        $("#jquery_jplayer_1").jPlayer("play", start);
    $("#title").html(t);
}
//]]>
</script>

</body>

</html>
